# 端口：输入 (`input.ts`)

该文件定义了与用户输入相关的核心接口和数据结构，作为领域层与具体输入设备（如浏览器键盘、鼠标）之间的“端口”或“契约”。它确保了领域逻辑的独立性，使其不直接依赖于任何特定的输入实现。

## 核心设计

- **抽象化**：将原始的、多样的浏览器事件（如 `keydown`, `mousemove`, `wheel`）抽象成一个统一的、可轮询的状态对象 `InputState`。
- **轮询式接口**：提供 `getState()` 方法，允许任何系统在需要时获取当前的输入快照，而不是通过事件监听被动接收。这简化了系统内的逻辑，使其更易于控制和测试。

## 接口与类型

### `KeyCode`

标准化的按键代码字符串。

- **类型**: `string`
- **用途**: 用于表示键盘或鼠标按键的唯一标识符，例如 `'KeyW'`, `'MouseLeft'`。

### `InputState` 接口

聚合了所有输入信息的快照对象。

- **`axes: { x: number; y: number }`**:
  - **描述**: 标准化的二维移动轴。通常由 `W/A/S/D` 或方向键映射而来。
  - **值域**: `x` 和 `y` 的值通常在 `[-1, 1]` 区间内。`y` 代表前/后，`x` 代表左/右。

- **`yawDelta: number`**:
  - **描述**: 鼠标在水平方向（X轴）上的移动增量。用于控制相机的水平旋转（偏航角）。
  - **用途**: 在每一帧中累加，并在帧末被重置。

- **`pitchDelta: number`**:
  - **描述**: 鼠标在垂直方向（Y轴）上的移动增量。用于控制相机的垂直旋转（俯仰角）。
  - **用途**: 在每一帧中累加，并在帧末被重置。

- **`wheelDelta: number`**:
  - **描述**: 鼠标滚轮的滚动增量。
  - **用途**: 主要用于相机缩放。在每一帧中累加，并在帧末被重置。

- **`pressed: Set<KeyCode>`**:
  - **描述**: 一个集合，包含了当前所有被按下的按键。
  - **用途**: 用于检查特定按键是否处于“长按”状态。

- **`lastClick?: { xNdc: number; yNdc: number; button: number }`**:
  - **描述**: 记录最近一次的鼠标点击事件。坐标被归一化到设备坐标（NDC），范围为 `[-1, 1]`。
  - **`xNdc`**: 水平坐标。
  - **`yNdc`**: 垂直坐标。
  - **`button`**: 点击的按键（例如 `0` 代表左键，`2` 代表右键）。
  - **用途**: 用于处理需要精确点击位置的场景，如点击地面移动或UI交互。该状态同样在帧末被重置。

### `InputPort` 接口

输入端口的契约，由具体的适配器（如 `BrowserInputAdapter`）实现。

- **`getState(): InputState`**:
  - **描述**: 获取当前帧的输入状态快照。
  - **返回**: 一个 `InputState` 对象。

- **`resetFrameDeltas(): void`**:
  - **描述**: 重置所有“增量”性质的状态，包括 `yawDelta`, `pitchDelta`, `wheelDelta` 和 `lastClick`。
  - **调用时机**: 通常在每一帧的末尾由主循环调用，以确保下一帧的增量是从零开始计算的。

## 使用流程

1.  **装配**: 在应用启动时，创建一个具体的 `InputPort` 实现（例如 `createBrowserInputAdapter`）并将其注册到 `World` 对象的 `ports.input` 中。
2.  **系统内使用**: 任何需要输入的系统（如 `MovementSystem`, `CameraSystem`）在 `update` 循环中，通过 `world.ports.input.getState()` 获取当前输入状态。
3.  **帧末重置**: 主循环在所有系统更新完毕后，调用 `world.ports.input.resetFrameDeltas()`，为下一帧做准备。
